<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Command Center</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar for that industrial feel */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #09090b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #27272a; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3f3f46; 
        }

        body {
            background-color: #000000;
            color: #e4e4e7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .font-mono-tech {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            letter-spacing: -0.02em;
        }

        /* Glassmorphism inputs */
        .input-tech {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #27272a;
            color: white;
            transition: all 0.2s ease;
        }
        .input-tech:focus {
            outline: none;
            border-color: #52525b;
            background: rgba(255, 255, 255, 0.07);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuration ---
        const DEFAULT_HABITS = [
            { id: 'run', name: 'Running', type: 'numeric', unit: 'min', category: 'physical', color: '#3b82f6' }, // Blue
            { id: 'gym', name: 'Gym', type: 'boolean', category: 'physical', color: '#06b6d4' }, // Cyan
            { id: 'pushups', name: 'Pushups', type: 'numeric', unit: 'count', category: 'physical', color: '#10b981' }, // Emerald
            { id: 'situps', name: 'Situps', type: 'numeric', unit: 'count', category: 'physical', color: '#84cc16' }, // Lime
            { id: 'reading', name: 'Reading', type: 'boolean', category: 'intellect', color: '#f59e0b' }, // Amber
            { id: 'learning', name: 'Learning', type: 'boolean', category: 'intellect', color: '#d946ef' }, // Fuchsia
            { id: 'vibe_coding', name: 'Vibe Coding', type: 'boolean', category: 'creative', color: '#8b5cf6' }, // Violet
            { id: 'play', name: 'Play', type: 'boolean', category: 'wellbeing', color: '#f43f5e' }, // Rose
        ];

        // --- Components ---

        // 1. Icon Component Wrapper
        const Icon = ({ name, size = 20, className }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // 2. Modal Component
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-[#09090b] border border-zinc-800 w-full max-w-md rounded-lg shadow-2xl overflow-hidden animate-fade-in">
                        <div className="flex justify-between items-center p-4 border-b border-zinc-800">
                            <h3 className="font-mono-tech font-bold text-zinc-100">{title}</h3>
                            <button onClick={onClose} className="text-zinc-500 hover:text-white">
                                <Icon name="x" size={20} />
                            </button>
                        </div>
                        <div className="p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Analytics Chart Component
        const AnalyticsChart = ({ logs }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;

                // Process Data for Chart
                // Group by date, sum up numeric, count booleans
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (6 - i));
                    return d.toISOString().split('T')[0];
                });

                const datasets = DEFAULT_HABITS.map(habit => {
                    const data = last7Days.map(date => {
                        const entry = logs.find(l => l.date === date && l.habit === habit.name);
                        if (!entry) return 0;
                        return habit.type === 'numeric' ? parseFloat(entry.value) : 1;
                    });

                    return {
                        label: habit.name,
                        data: data,
                        borderColor: habit.color,
                        backgroundColor: habit.color + '20', // Transparent fill
                        borderWidth: 1,
                        tension: 0.3,
                        pointRadius: 2
                    };
                });

                if (chartRef.current) chartRef.current.destroy();

                chartRef.current = new Chart(canvasRef.current, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(d => d.slice(5)), // MM-DD
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#a1a1aa', font: { family: 'Menlo' }, boxWidth: 10 }
                            }
                        },
                        scales: {
                            y: {
                                grid: { color: '#27272a' },
                                ticks: { color: '#71717a' }
                            },
                            x: {
                                grid: { color: '#27272a' },
                                ticks: { color: '#71717a' }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [logs]);

            return (
                <div className="w-full h-64 bg-[#09090b] border border-zinc-800 rounded-lg p-4 relative">
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        };

        // --- Main Application ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('log');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [logs, setLogs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [error, setError] = useState(null);
            
            // Current Log State (for the form)
            const [dailyEntries, setDailyEntries] = useState({});

            // Settings State
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('habitSettings');
                return saved ? JSON.parse(saved) : { googleScriptUrl: '', mode: 'local' };
            });

            // Load Data on Mount
            useEffect(() => {
                loadData();
            }, [settings.mode]); // Reload if mode changes

            // Refresh icons when DOM changes
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const loadData = async () => {
                setError(null);
                setLoading(true);
                
                if (settings.mode === 'local') {
                    const localData = localStorage.getItem('habitLogs');
                    if (localData) setLogs(JSON.parse(localData));
                    setLoading(false);
                } else if (settings.mode === 'cloud') {
                    if (!settings.googleScriptUrl) {
                        setLoading(false);
                        return; // Wait for user to input URL
                    }
                    
                    try {
                        // Use credentials: 'omit' to fix CORS issues with Google Apps Script
                        const response = await fetch(settings.googleScriptUrl, {
                            method: 'GET',
                            redirect: 'follow',
                            credentials: 'omit' 
                        });
                        
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        
                        const data = await response.json();
                        setLogs(Array.isArray(data) ? data : []);
                    } catch (err) {
                        console.error("Fetch error:", err);
                        setError("Connection failed. Check your URL or internet.");
                        // Fallback to local just so app doesn't look broken
                        const localData = localStorage.getItem('habitLogs');
                        if (localData) setLogs(JSON.parse(localData));
                    } finally {
                        setLoading(false);
                    }
                }
            };

            const handleSaveSettings = (newSettings) => {
                setSettings(newSettings);
                localStorage.setItem('habitSettings', JSON.stringify(newSettings));
                setIsSettingsOpen(false);
                // Data reload triggered by useEffect dependency on settings.mode
                if (newSettings.mode === 'cloud' && newSettings.googleScriptUrl !== settings.googleScriptUrl) {
                     setTimeout(loadData, 100); // Force reload if URL changed
                }
            };

            const handleInputChange = (habitId, value) => {
                setDailyEntries(prev => ({
                    ...prev,
                    [habitId]: value
                }));
            };

            const handleSubmit = async () => {
                setLoading(true);
                setError(null);
                
                // Prepare payload
                const habitsToLog = [];
                
                DEFAULT_HABITS.forEach(habit => {
                    let val = dailyEntries[habit.id];
                    
                    // Logic: If boolean and true, or numeric and > 0
                    if (habit.type === 'boolean' && val === true) {
                        habitsToLog.push({ name: habit.name, type: 'boolean', value: 1 });
                    } else if (habit.type === 'numeric' && val && val > 0) {
                        habitsToLog.push({ name: habit.name, type: 'numeric', value: val });
                    }
                });

                if (habitsToLog.length === 0) {
                    alert("No habits entered to save.");
                    setLoading(false);
                    return;
                }

                const payload = {
                    date: selectedDate,
                    habits: habitsToLog
                };

                // Optimistic UI Update (update local logs immediately)
                const newEntries = habitsToLog.map(h => ({
                    date: selectedDate,
                    habit: h.name,
                    type: h.type,
                    value: h.value
                }));
                const optimisticLogs = [...logs, ...newEntries];
                setLogs(optimisticLogs);

                // Save logic
                if (settings.mode === 'local') {
                    // Remove existing entries for this date to avoid dupes (simple implementation)
                    const cleanLogs = logs.filter(l => l.date !== selectedDate);
                    const updatedLogs = [...cleanLogs, ...newEntries];
                    
                    localStorage.setItem('habitLogs', JSON.stringify(updatedLogs));
                    setLogs(updatedLogs);
                    setDailyEntries({});
                    setLoading(false);
                    alert("Saved to Local Storage");
                } else {
                    // Cloud Save
                    try {
                        // Use no-cors for Google Apps Script POST requests
                        await fetch(settings.googleScriptUrl, {
                            method: 'POST',
                            mode: 'no-cors', 
                            headers: {
                                'Content-Type': 'text/plain', // Send as plain text to avoid preflight options check
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        setDailyEntries({});
                        alert("Sync initiated to Cloud.");
                    } catch (e) {
                        console.error("Upload Error", e);
                        setError("Failed to sync to cloud. Data saved locally in memory only.");
                    } finally {
                        setLoading(false);
                    }
                }
            };

            // --- Views ---

            const renderLogView = () => (
                <div className="animate-fade-in space-y-6 max-w-2xl mx-auto">
                    <div className="bg-[#09090b] border border-zinc-800 p-6 rounded-xl shadow-xl">
                        <div className="flex items-center justify-between mb-8 border-b border-zinc-800 pb-4">
                            <h2 className="text-xl font-mono-tech tracking-widest text-white uppercase">Daily Protocol</h2>
                            <input 
                                type="date" 
                                value={selectedDate}
                                onChange={(e) => setSelectedDate(e.target.value)}
                                className="input-tech px-4 py-2 rounded bg-black text-zinc-300 font-mono text-sm"
                            />
                        </div>

                        <div className="space-y-6">
                            {DEFAULT_HABITS.map(habit => (
                                <div key={habit.id} className="flex items-center justify-between group">
                                    <div className="flex items-center space-x-3">
                                        <div className={`w-1 h-8 rounded-full transition-all duration-300 ${dailyEntries[habit.id] ? 'bg-opacity-100' : 'bg-opacity-30'}`} style={{backgroundColor: habit.color}}></div>
                                        <span className="text-zinc-300 font-medium text-sm tracking-wide">{habit.name}</span>
                                    </div>
                                    
                                    <div className="w-32">
                                        {habit.type === 'numeric' ? (
                                            <div className="relative">
                                                <input 
                                                    type="number" 
                                                    placeholder="0"
                                                    value={dailyEntries[habit.id] || ''}
                                                    onChange={(e) => handleInputChange(habit.id, e.target.value)}
                                                    className="input-tech w-full px-3 py-2 rounded text-right text-white"
                                                />
                                                <span className="absolute right-8 top-2 text-xs text-zinc-500 pointer-events-none">{habit.unit}</span>
                                            </div>
                                        ) : (
                                            <button 
                                                onClick={() => handleInputChange(habit.id, !dailyEntries[habit.id])}
                                                className={`w-full py-2 rounded border transition-all duration-200 text-xs uppercase font-bold tracking-wider
                                                    ${dailyEntries[habit.id] 
                                                        ? `bg-white text-black border-white` 
                                                        : 'bg-transparent text-zinc-500 border-zinc-800 hover:border-zinc-600'}`}
                                            >
                                                {dailyEntries[habit.id] ? 'COMPLETE' : 'PENDING'}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-10 pt-6 border-t border-zinc-800 flex justify-end">
                            <button 
                                onClick={handleSubmit} 
                                disabled={loading}
                                className="bg-white text-black px-8 py-3 rounded font-bold tracking-widest hover:bg-zinc-200 transition-colors disabled:opacity-50 text-sm font-mono-tech"
                            >
                                {loading ? 'SYNCING...' : 'COMMIT PROTOCOL'}
                            </button>
                        </div>
                    </div>
                </div>
            );

            const renderCalendarView = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth(); // 0-indexed
                
                // Get days in month
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDay = new Date(year, month, 1).getDay();
                
                const days = [];
                for(let i = 0; i < startDay; i++) days.push(null);
                for(let i = 1; i <= daysInMonth; i++) days.push(i);

                return (
                    <div className="animate-fade-in">
                        <div className="grid grid-cols-7 gap-2 mb-2 text-center">
                            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                                <div key={d} className="text-zinc-600 text-xs font-mono uppercase">{d}</div>
                            ))}
                        </div>
                        <div className="grid grid-cols-7 gap-2">
                            {days.map((d, idx) => {
                                if (!d) return <div key={idx} className="aspect-square"></div>;
                                
                                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                const daysLogs = logs.filter(l => l.date === dateStr); // Not efficient for large datasets but fine for this scale

                                return (
                                    <div key={idx} className="aspect-square bg-[#09090b] border border-zinc-800 rounded flex flex-col items-start justify-between p-1 hover:border-zinc-600 transition-colors relative overflow-hidden">
                                        <span className="text-zinc-500 text-[10px] font-mono">{d}</span>
                                        <div className="flex flex-wrap gap-1 content-end w-full">
                                            {daysLogs.map((log, li) => {
                                                const hab = DEFAULT_HABITS.find(h => h.name === log.habit);
                                                if(!hab) return null;
                                                return (
                                                    <div 
                                                        key={li} 
                                                        className="w-1.5 h-1.5 rounded-full" 
                                                        style={{backgroundColor: hab.color}}
                                                        title={`${log.habit}: ${log.value}`}
                                                    ></div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const renderAnalyticsView = () => {
                // Calculate some simple stats
                const totalPushups = logs.filter(l => l.habit === 'Pushups').reduce((acc, cur) => acc + parseFloat(cur.value), 0);
                const totalRunTime = logs.filter(l => l.habit === 'Running').reduce((acc, cur) => acc + parseFloat(cur.value), 0);
                const totalVibeCoding = logs.filter(l => l.habit === 'Vibe Coding').length;

                return (
                    <div className="animate-fade-in space-y-6">
                        
                        {/* Stat Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-[#09090b] border border-zinc-800 p-4 rounded">
                                <div className="text-zinc-500 text-xs uppercase tracking-widest font-mono mb-2">Total Pushups</div>
                                <div className="text-3xl font-bold text-white">{totalPushups}</div>
                            </div>
                            <div className="bg-[#09090b] border border-zinc-800 p-4 rounded">
                                <div className="text-zinc-500 text-xs uppercase tracking-widest font-mono mb-2">Total Run Time</div>
                                <div className="text-3xl font-bold text-white">{totalRunTime}<span className="text-sm text-zinc-600 ml-1">min</span></div>
                            </div>
                            <div className="bg-[#09090b] border border-zinc-800 p-4 rounded">
                                <div className="text-zinc-500 text-xs uppercase tracking-widest font-mono mb-2">Vibe Coding Sessions</div>
                                <div className="text-3xl font-bold text-white">{totalVibeCoding}</div>
                            </div>
                        </div>

                        <div className="bg-[#09090b] border border-zinc-800 p-6 rounded-xl">
                             <h3 className="text-sm font-mono-tech text-zinc-400 mb-4 uppercase">7-Day Performance Velocity</h3>
                             <AnalyticsChart logs={logs} />
                        </div>
                    </div>
                );
            };

            // Helper: Check if URL looks like a GAS web app
            const isGASUrl = (url) => url.includes('script.google.com') && url.endsWith('/exec');

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <header className="sticky top-0 z-40 backdrop-blur-md border-b border-zinc-800 bg-black/50">
                        <div className="max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <div className={`w-3 h-3 rounded-full ${loading ? 'bg-yellow-500 animate-pulse' : 'bg-white'}`}></div>
                                <h1 className="text-lg font-bold tracking-tighter">HABIT OS</h1>
                            </div>
                            <div className="flex items-center space-x-4">
                                {error && (
                                    <span className="text-xs text-red-500 font-mono animate-pulse hidden md:block">CONNECTION ERROR</span>
                                )}
                                <button onClick={() => setIsSettingsOpen(true)} className="text-zinc-500 hover:text-white transition-colors">
                                    <Icon name="settings" size={20} />
                                </button>
                            </div>
                        </div>
                        {error && (
                            <div className="bg-red-900/30 border-b border-red-900/50 p-2 text-center md:hidden">
                                <span className="text-xs text-red-400 font-mono">{error}</span>
                            </div>
                        )}
                    </header>

                    {/* Main Content */}
                    <main className="max-w-3xl mx-auto px-4 py-8">
                        {activeTab === 'log' && renderLogView()}
                        {activeTab === 'calendar' && renderCalendarView()}
                        {activeTab === 'analytics' && renderAnalyticsView()}
                    </main>

                    {/* Navigation Bar */}
                    <nav className="fixed bottom-0 left-0 w-full border-t border-zinc-800 bg-black/90 backdrop-blur pb-safe">
                         <div className="max-w-md mx-auto flex justify-around p-4">
                            <button 
                                onClick={() => setActiveTab('log')} 
                                className={`flex flex-col items-center space-y-1 ${activeTab === 'log' ? 'text-white' : 'text-zinc-600'}`}
                            >
                                <Icon name="pen-tool" size={20} />
                                <span className="text-[10px] font-mono uppercase tracking-wider">Log</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('calendar')} 
                                className={`flex flex-col items-center space-y-1 ${activeTab === 'calendar' ? 'text-white' : 'text-zinc-600'}`}
                            >
                                <Icon name="calendar" size={20} />
                                <span className="text-[10px] font-mono uppercase tracking-wider">Viz</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('analytics')} 
                                className={`flex flex-col items-center space-y-1 ${activeTab === 'analytics' ? 'text-white' : 'text-zinc-600'}`}
                            >
                                <Icon name="activity" size={20} />
                                <span className="text-[10px] font-mono uppercase tracking-wider">Data</span>
                            </button>
                        </div>
                    </nav>

                    {/* Settings Modal */}
                    <Modal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        title="SYSTEM CONFIGURATION"
                    >
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs text-zinc-500 font-mono mb-1 uppercase">Storage Mode</label>
                                <select 
                                    className="input-tech w-full px-3 py-2 rounded text-sm bg-black"
                                    value={settings.mode}
                                    onChange={(e) => setSettings({...settings, mode: e.target.value})}
                                >
                                    <option value="local">Local Storage (Demo)</option>
                                    <option value="cloud">Google Sheets (Live)</option>
                                </select>
                            </div>

                            {settings.mode === 'cloud' && (
                                <div>
                                    <label className="block text-xs text-zinc-500 font-mono mb-1 uppercase">Apps Script Web App URL</label>
                                    <input 
                                        type="text" 
                                        value={settings.googleScriptUrl}
                                        onChange={(e) => setSettings({...settings, googleScriptUrl: e.target.value})}
                                        placeholder="https://script.google.com/.../exec"
                                        className={`input-tech w-full px-3 py-2 rounded text-xs font-mono ${
                                            settings.googleScriptUrl && !isGASUrl(settings.googleScriptUrl) 
                                            ? 'border-yellow-600 text-yellow-500' 
                                            : 'text-zinc-400'
                                        }`}
                                    />
                                    {settings.googleScriptUrl && !isGASUrl(settings.googleScriptUrl) && (
                                        <p className="text-[10px] text-yellow-500 mt-1">Warning: URL usually ends in '/exec'</p>
                                    )}
                                    <p className="text-[10px] text-zinc-600 mt-2">
                                        Deploy your Google Apps Script as a Web App with access set to "Anyone" and paste the URL here.
                                    </p>
                                </div>
                            )}

                            <button 
                                onClick={() => handleSaveSettings(settings)}
                                className="w-full bg-white text-black py-2 rounded font-bold text-sm hover:bg-zinc-200"
                            >
                                SAVE CONFIG
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
