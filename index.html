<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit Command Center</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Industrial Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }

        body {
            background-color: #000000;
            color: #e4e4e7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        .font-mono-tech { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; letter-spacing: -0.02em; }

        .input-tech {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #27272a;
            color: white;
            transition: all 0.2s ease;
        }
        .input-tech:focus {
            outline: none;
            border-color: #52525b;
            background: rgba(255, 255, 255, 0.07);
        }

        /* Remove Spinners from Number Inputs */
        .no-spinner::-webkit-inner-spin-button, 
        .no-spinner::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .no-spinner {
            -moz-appearance: textfield;
        }

        /* Mobile Optimizations */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        @media (max-width: 768px) {
            .modal-content {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                border-radius: 1rem 1rem 0 0;
                max-height: 85vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Config & Utilities ---
        const DEFAULT_HABITS = [
            { id: 'run', name: 'Running', type: 'numeric', unit: 'min', category: 'physical', color: '#3b82f6', icon: 'activity' },
            { id: 'gym', name: 'Gym', type: 'boolean', category: 'physical', color: '#06b6d4', icon: 'dumbbell' },
            { id: 'pushups', name: 'Pushups', type: 'numeric', unit: 'count', category: 'physical', color: '#10b981', icon: 'biceps-flexed' },
            { id: 'reading', name: 'Reading', type: 'boolean', category: 'intellect', color: '#f59e0b', icon: 'book-open' },
            { id: 'vibe', name: 'Vibe Coding', type: 'boolean', category: 'creative', color: '#8b5cf6', icon: 'code' },
        ];

        const ICON_OPTIONS = [
            'activity', 'dumbbell', 'biceps-flexed', 'book-open', 'code', 'zap', 'brain', 
            'flame', 'droplet', 'moon', 'sun', 'coffee', 'music', 'gamepad-2', 'briefcase', 
            'dollar-sign', 'heart', 'smile', 'star', 'trophy', 'timer', 'footprints'
        ];

        const Icon = ({ name, size = 20, className }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- UI Components ---

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
            const colors = type === 'success' ? 'bg-emerald-950/90 border-emerald-800 text-emerald-200' : 'bg-red-950/90 border-red-800 text-red-200';
            return (
                <div className={`fixed top-6 right-4 z-[60] px-4 py-3 rounded border flex items-center space-x-3 backdrop-blur-md shadow-2xl animate-slide-in ${colors}`}>
                    <Icon name={type === 'success' ? 'check' : 'alert-circle'} size={18} />
                    <span className="font-mono text-xs uppercase font-bold tracking-wider">{message}</span>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="modal-content bg-[#09090b] border border-zinc-800 w-full max-w-md rounded-lg shadow-2xl animate-slide-in md:rounded-lg">
                        <div className="flex justify-between items-center p-4 border-b border-zinc-800 sticky top-0 bg-[#09090b] z-10 rounded-t-lg">
                            <h3 className="font-mono-tech font-bold text-zinc-100 uppercase tracking-wider">{title}</h3>
                            <button onClick={onClose} className="text-zinc-500 hover:text-white p-2"><Icon name="x" size={20} /></button>
                        </div>
                        <div className="p-4 max-h-[75vh] overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };

        const Heatmap = ({ logs }) => {
            const weeks = 16;
            const today = new Date();
            const dayOfWeek = today.getDay(); 
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + (6 - dayOfWeek));
            
            // Optimization: Create Set for O(1) lookups
            const activeDates = useMemo(() => new Set(logs.map(l => l.date)), [logs]);

            const grid = [];
            for (let w = 0; w < weeks; w++) {
                const weekData = [];
                for (let d = 0; d < 7; d++) {
                    const date = new Date(endDate);
                    date.setDate(endDate.getDate() - ((weeks - 1 - w) * 7 + (6 - d)));
                    const dateStr = date.toLocaleDateString('en-CA');
                    
                    // Consistency Logic: Rolling 7-Day Attendance
                    // Measures momentum (streakiness) rather than daily volume
                    let activeDaysInWindow = 0;
                    for(let k = 0; k < 7; k++) {
                        const lookback = new Date(date);
                        lookback.setDate(date.getDate() - k);
                        const lookbackStr = lookback.toLocaleDateString('en-CA');
                        if (activeDates.has(lookbackStr)) activeDaysInWindow++;
                    }

                    // Map 0-7 active days to intensity 0-4
                    let intensity = 0;
                    if (activeDaysInWindow >= 1) intensity = 1; // 1-2 days
                    if (activeDaysInWindow >= 3) intensity = 2; // 3-4 days
                    if (activeDaysInWindow >= 5) intensity = 3; // 5-6 days
                    if (activeDaysInWindow >= 7) intensity = 4; // Perfect week
                    
                    weekData.push({ date: dateStr, intensity });
                }
                grid.push(weekData);
            }

            // Color Logic: Blue -> Green (Brighter)
            const getIntensityColor = (i) => {
                if (i === 0) return 'bg-zinc-900';
                if (i === 1) return 'bg-blue-800';      // Deep Blue
                if (i === 2) return 'bg-blue-500';      // Bright Blue
                if (i === 3) return 'bg-teal-400';      // Bright Teal
                if (i === 4) return 'bg-green-400 shadow-[0_0_6px_rgba(74,222,128,0.7)]'; // Neon Green + Glow
                return 'bg-zinc-900';
            };

            return (
                <div className="w-full">
                    <div className="overflow-x-auto pb-2">
                        <div className="flex gap-1 min-w-max">
                            {grid.map((week, wi) => (
                                <div key={wi} className="flex flex-col gap-1">
                                    {week.map((day, di) => (
                                        <div key={di} 
                                            className={`w-3 h-3 rounded-sm transition-all duration-300 ${getIntensityColor(day.intensity)}`} 
                                            title={`${day.date}: ${day.intensity} (7-day momentum)`}
                                        ></div>
                                    ))}
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    {/* Legend */}
                    <div className="flex items-center justify-end gap-2 mt-3 border-t border-zinc-800/50 pt-2">
                        <span className="text-[9px] uppercase font-mono text-zinc-600 tracking-wider">Consistency</span>
                        <div className="flex gap-1.5">
                            {[0,1,2,3,4].map(i => (
                                <div key={i} className={`w-2.5 h-2.5 rounded-sm ${getIntensityColor(i)}`}></div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Analytics Chart Component ---
        const AnalyticsChart = ({ logs, habits, showLegend = false }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (6 - i));
                    return d.toLocaleDateString('en-CA');
                });

                const datasets = habits.map(habit => {
                    const data = last7Days.map(date => {
                        const entry = logs.find(l => l.date === date && (l.habitId === habit.id || l.habit === habit.name));
                        if (!entry) return 0;
                        return habit.type === 'numeric' ? parseFloat(entry.value) : 1;
                    });
                    return {
                        label: habit.name,
                        data: data,
                        borderColor: habit.color,
                        backgroundColor: habit.color + '20',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: showLegend ? 3 : 2,
                        pointBackgroundColor: habit.color
                    };
                });

                if (chartRef.current) chartRef.current.destroy();
                
                chartRef.current = new Chart(canvasRef.current, {
                    type: 'line',
                    data: { labels: last7Days.map(d => d.slice(5)), datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                display: showLegend,
                                labels: {
                                    color: '#71717a',
                                    font: { family: 'monospace', size: 10 },
                                    boxWidth: 10
                                }
                            } 
                        },
                        scales: {
                            y: { 
                                grid: { color: '#27272a' }, 
                                ticks: { color: '#52525b', font: { family: 'monospace' } },
                                beginAtZero: true
                            },
                            x: { 
                                grid: { color: '#27272a' }, 
                                ticks: { color: '#52525b', font: { family: 'monospace' } } 
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                    }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [logs, habits, showLegend]);

            return <div className="w-full h-full"><canvas ref={canvasRef}></canvas></div>;
        };

        // --- Sub-Components ---

        const LogView = ({ habits, dailyEntries, setDailyEntries, selectedDate, setSelectedDate, onCommit, loading }) => {
            return (
                <div className="space-y-6 animate-slide-in">
                    <div className="bg-[#09090b] border border-zinc-800 p-5 rounded-xl shadow-lg">
                        <div className="flex items-center justify-between mb-6 border-b border-zinc-800 pb-4">
                            <h2 className="text-lg font-mono-tech tracking-widest text-white uppercase">Protocol</h2>
                            <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)}
                                className="input-tech px-3 py-2 rounded bg-black text-zinc-300 font-mono text-sm" />
                        </div>
                        <div className="space-y-5">
                            {habits.map(habit => {
                                const val = dailyEntries[habit.id];
                                const isDone = habit.type === 'boolean' ? val === true : (val !== undefined && val !== '');
                                
                                return (
                                    <div key={habit.id} className="flex items-center justify-between group">
                                        <div className="flex items-center space-x-3 flex-1">
                                            <div className={`p-2 rounded-lg transition-colors ${isDone ? 'bg-zinc-800 text-white' : 'bg-zinc-900 text-zinc-600'}`}>
                                                <Icon name={habit.icon} size={20} />
                                            </div>
                                            <span className={`text-sm font-medium transition-colors ${isDone ? 'text-white' : 'text-zinc-400'}`}>{habit.name}</span>
                                        </div>
                                        
                                        <div className="w-36 flex justify-end">
                                            {habit.type === 'numeric' ? (
                                                <div className="flex items-center space-x-2">
                                                    <input 
                                                        type="number" 
                                                        placeholder="0" 
                                                        value={val || ''}
                                                        onChange={(e) => setDailyEntries(prev => ({...prev, [habit.id]: e.target.value}))}
                                                        className={`input-tech w-20 px-2 py-2 rounded text-center text-lg font-mono no-spinner ${isDone ? 'border-zinc-500 text-white' : 'border-zinc-800 text-zinc-500'}`} 
                                                    />
                                                    <span className="text-xs text-zinc-600 font-mono w-8">{habit.unit}</span>
                                                </div>
                                            ) : (
                                                <button onClick={() => setDailyEntries(prev => ({...prev, [habit.id]: !val}))}
                                                    className={`w-full py-2 rounded border text-xs font-bold tracking-widest transition-all
                                                        ${isDone ? `bg-[${habit.color}] border-transparent text-black` : 'bg-transparent border-zinc-800 text-zinc-600'}`}
                                                    style={isDone ? {backgroundColor: habit.color} : {}}>
                                                    {isDone ? 'DONE' : 'PENDING'}
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                        <div className="mt-8 pt-4 border-t border-zinc-800">
                            <button 
                                onClick={onCommit} 
                                disabled={loading}
                                className="w-full bg-white text-black py-3.5 rounded font-mono font-bold tracking-widest hover:bg-zinc-200 transition-colors disabled:opacity-50 shadow-lg">
                                {loading ? 'SYNCING...' : 'COMMIT PROTOCOL'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ logs, habits, setViewingDay }) => {
            const today = new Date();
            const [viewDate, setViewDate] = useState(new Date());
            const [selectedHabitId, setSelectedHabitId] = useState(null);
            
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            
            const startOfMonth = new Date(year, month, 1);
            const endOfMonth = new Date(year, month + 1, 0);
            const startDay = startOfMonth.getDay(); // 0 is Sunday
            const daysInMonth = endOfMonth.getDate();
            
            const days = Array(startDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1));

            // Filter Logic
            const filteredLogs = useMemo(() => {
                if (!selectedHabitId) return logs;
                const selectedHabit = habits.find(h => h.id === selectedHabitId);
                if (!selectedHabit) return logs;
                return logs.filter(l => l.habitId === selectedHabitId || l.habit === selectedHabit.name);
            }, [logs, selectedHabitId, habits]);

            return (
                <div className="space-y-6 animate-slide-in pb-safe">
                    
                    {/* Filter Bar */}
                    <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4">
                        <button 
                            onClick={() => setSelectedHabitId(null)}
                            className={`px-4 py-2 rounded-full text-[10px] font-mono font-bold uppercase tracking-wider border whitespace-nowrap transition-all
                                ${!selectedHabitId ? 'bg-white text-black border-white' : 'bg-zinc-900 text-zinc-500 border-zinc-800'}`}
                        >
                            All Activity
                        </button>
                        {habits.map(h => (
                            <button 
                                key={h.id}
                                onClick={() => setSelectedHabitId(selectedHabitId === h.id ? null : h.id)}
                                className={`px-4 py-2 rounded-full text-[10px] font-mono font-bold uppercase tracking-wider border whitespace-nowrap transition-all flex items-center gap-2
                                    ${selectedHabitId === h.id ? 'text-black border-transparent' : 'bg-zinc-900 text-zinc-500 border-zinc-800'}`}
                                style={selectedHabitId === h.id ? { backgroundColor: h.color } : {}}
                            >
                                <Icon name={h.icon} size={14} />
                                {h.name}
                            </button>
                        ))}
                    </div>

                    {/* Heatmap Header */}
                    <div className="bg-[#09090b] border border-zinc-800 p-4 rounded-xl overflow-hidden">
                        <div className="flex items-center justify-between mb-2">
                            <h3 className="text-xs font-mono text-zinc-500 uppercase">
                                {selectedHabitId ? `${habits.find(h => h.id === selectedHabitId)?.name} Consistency` : "Consistency Map"}
                            </h3>
                            <span className="text-[10px] text-zinc-600">Last 16 Weeks</span>
                        </div>
                        <Heatmap logs={filteredLogs} />
                    </div>

                    <div className="bg-[#09090b] border border-zinc-800 p-4 rounded-xl">
                         <div className="flex justify-between items-center mb-6">
                            <button onClick={() => setViewDate(new Date(year, month - 1, 1))} className="p-2 hover:bg-zinc-800 rounded"><Icon name="chevron-left" size={18} /></button>
                            <span className="font-mono-tech font-bold text-sm tracking-widest">{viewDate.toLocaleString('default', { month: 'long', year: 'numeric' }).toUpperCase()}</span>
                            <button onClick={() => setViewDate(new Date(year, month + 1, 1))} className="p-2 hover:bg-zinc-800 rounded"><Icon name="chevron-right" size={18} /></button>
                        </div>
                        
                        <div className="grid grid-cols-7 gap-1 text-center mb-3">
                            {['S','M','T','W','T','F','S'].map((d, i) => <div key={i} className="text-[10px] text-zinc-600 font-mono">{d}</div>)}
                        </div>
                        
                        <div className="grid grid-cols-7 gap-1">
                            {days.map((d, i) => {
                                if (!d) return <div key={i} className="aspect-square"></div>;
                                
                                const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                
                                // Use filteredLogs here
                                const dayLogs = filteredLogs.filter(l => l.date === dateStr);
                                const isToday = dateStr === today.toLocaleDateString('en-CA');
                                
                                return (
                                    <button key={i} 
                                        onClick={() => dayLogs.length > 0 && setViewingDay({ date: dateStr, logs: dayLogs })}
                                        className={`aspect-square rounded flex flex-col items-center justify-start pt-1 relative border transition-all
                                            ${isToday ? 'border-zinc-500 bg-zinc-900' : 'border-zinc-800/50 bg-black hover:bg-zinc-900'}
                                            ${dayLogs.length === 0 && selectedHabitId ? 'opacity-20' : 'opacity-100'} 
                                        `} 
                                    >
                                        <span className={`text-[10px] font-mono ${dayLogs.length > 0 ? 'text-white font-bold' : 'text-zinc-600'}`}>{d}</span>
                                        <div className="grid grid-cols-2 gap-0.5 mt-1 w-full px-1">
                                            {dayLogs.slice(0,4).map((l, idx) => {
                                                const hab = habits.find(h => h.name === l.habit) || {};
                                                return (
                                                    <div key={idx} className="flex justify-center items-center">
                                                         <div style={{color: hab.color || '#555'}}>
                                                            <Icon name={hab.icon || 'circle'} size={8} />
                                                         </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const AnalyticsView = ({ logs, habits }) => {
            const stats = habits.map(h => {
                const hLogs = logs.filter(l => (l.habitId === h.id || l.habit === h.name));
                const total = h.type === 'numeric' 
                    ? hLogs.reduce((acc, cur) => acc + (parseFloat(cur.value) || 0), 0)
                    : hLogs.length;
                return { ...h, total };
            });

            const numericHabits = habits.filter(h => h.type === 'numeric');
            const booleanHabits = habits.filter(h => h.type === 'boolean');

            return (
                <div className="animate-slide-in space-y-6">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 gap-3">
                        {stats.map(stat => (
                            <div key={stat.id} className="bg-[#09090b] border border-zinc-800 p-4 rounded-xl">
                                <div className="flex items-center gap-2 text-zinc-500 mb-2">
                                    <Icon name={stat.icon} size={14} />
                                    <span className="text-[10px] uppercase font-mono tracking-wider">{stat.name}</span>
                                </div>
                                <div className="text-2xl font-bold text-white">
                                    {stat.total} <span className="text-xs text-zinc-600 font-normal">{stat.unit || 'sessions'}</span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Individual Numeric Charts */}
                    {numericHabits.map(h => (
                         <div key={h.id} className="bg-[#09090b] border border-zinc-800 p-6 rounded-xl">
                             <h3 className="text-xs font-mono text-zinc-500 mb-4 uppercase tracking-widest">{h.name} Velocity (Last 7 Days)</h3>
                             <div className="h-48 w-full relative">
                                 <AnalyticsChart logs={logs} habits={[h]} />
                             </div>
                         </div>
                    ))}

                    {/* Combined Boolean Chart */}
                    {booleanHabits.length > 0 && (
                        <div className="bg-[#09090b] border border-zinc-800 p-6 rounded-xl">
                            <h3 className="text-xs font-mono text-zinc-500 mb-4 uppercase tracking-widest">Consistency Velocity</h3>
                            <div className="h-64 w-full relative">
                                <AnalyticsChart logs={logs} habits={booleanHabits} showLegend={true} />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = ({ logs, deleteLog }) => {
            const sortedLogs = [...logs].sort((a, b) => new Date(b.date) - new Date(a.date));
            return (
                <div className="animate-slide-in bg-[#09090b] border border-zinc-800 rounded-xl overflow-hidden">
                    <div className="p-4 border-b border-zinc-800">
                        <h2 className="text-lg font-mono-tech tracking-widest text-white uppercase">Log History</h2>
                    </div>
                    <div className="max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <table className="w-full text-left text-xs font-mono">
                            <thead className="bg-zinc-900 text-zinc-500 sticky top-0">
                                <tr>
                                    <th className="p-3">DATE</th>
                                    <th className="p-3">HABIT</th>
                                    <th className="p-3 text-right">VAL</th>
                                    <th className="p-3 text-right">ACT</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-zinc-800">
                                {sortedLogs.map(log => (
                                    <tr key={log.id || log.timestamp} className="hover:bg-zinc-900/50">
                                        <td className="p-3 text-zinc-400">{log.date.slice(5)}</td>
                                        <td className="p-3 text-white">{log.habit}</td>
                                        <td className="p-3 text-right text-zinc-400">{log.type === 'boolean' ? 'Done' : `${log.value}`}</td>
                                        <td className="p-3 text-right">
                                            <button onClick={() => deleteLog(log.id || log.timestamp)} className="text-red-500 hover:text-red-400">
                                                <Icon name="trash-2" size={14} />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Main App Container ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('log');
            
            // Initialize Date with Local Time String (YYYY-MM-DD)
            const [selectedDate, setSelectedDate] = useState(() => {
                const d = new Date();
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().split('T')[0];
            });

            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('habitLogs') || '[]'));
            const [habits, setHabits] = useState(() => JSON.parse(localStorage.getItem('habitConfig') || JSON.stringify(DEFAULT_HABITS)));
            
            // Form State (Batching)
            const [dailyEntries, setDailyEntries] = useState({});
            
            // Status & UI
            const [loading, setLoading] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('idle');
            const [notification, setNotification] = useState(null);
            
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [editingHabit, setEditingHabit] = useState(null);
            const [viewingDay, setViewingDay] = useState(null);

            const [settings, setSettings] = useState(() => JSON.parse(localStorage.getItem('habitSettings') || '{"mode":"local","googleScriptUrl":""}'));

            // Load entries when date changes
            useEffect(() => {
                const entriesForDay = logs.filter(l => l.date === selectedDate);
                const formState = {};
                entriesForDay.forEach(log => {
                    const habitId = log.habitId || habits.find(h => h.name === log.habit)?.id;
                    if(habitId) formState[habitId] = log.value;
                });
                setDailyEntries(formState);
            }, [selectedDate, logs]); 

            // Sync Engine
            useEffect(() => {
                if (settings.mode === 'cloud') syncWithCloud();
                else setConnectionStatus('local');
            }, [settings.mode]);

            const syncWithCloud = async () => {
                if (!settings.googleScriptUrl) return;
                setConnectionStatus('connecting');
                try {
                    const res = await fetch(`${settings.googleScriptUrl}?t=${Date.now()}`, { redirect: 'follow', credentials: 'omit' });
                    const data = await res.json();
                    if (data.status === 'success' && data.data) {
                        if (data.data.logs) {
                            // Sanitize Dates (Fix for Google Sheets ISO String issue)
                            const cleanLogs = data.data.logs.map(l => ({
                                ...l,
                                date: String(l.date).split('T')[0] // Keep only YYYY-MM-DD
                            }));
                            setLogs(cleanLogs);
                            localStorage.setItem('habitLogs', JSON.stringify(cleanLogs));
                        }
                        if (data.data.habits) {
                            setHabits(data.data.habits);
                            localStorage.setItem('habitConfig', JSON.stringify(data.data.habits));
                        }
                        setConnectionStatus('connected');
                    } else if (Array.isArray(data)) {
                         // Legacy Array Support
                         const cleanLogs = data.map(l => ({ ...l, date: String(l.date).split('T')[0] }));
                         setLogs(cleanLogs);
                         localStorage.setItem('habitLogs', JSON.stringify(cleanLogs));
                         setConnectionStatus('connected');
                    }
                } catch (e) {
                    setConnectionStatus('error');
                }
            };

            const pushToCloud = async (newLogs, newHabits) => {
                if (settings.mode !== 'cloud' || !settings.googleScriptUrl) return;
                try {
                    await fetch(settings.googleScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ 
                            action: 'overwrite', 
                            logs: newLogs, 
                            habits: newHabits 
                        })
                    });
                    setConnectionStatus('connected');
                } catch (e) {
                    setConnectionStatus('error');
                }
            };

            // --- Core Logic ---

            const handleCommit = () => {
                setLoading(true);
                
                const cleanLogs = logs.filter(l => l.date !== selectedDate);
                const newEntries = [];
                
                habits.forEach(habit => {
                    const val = dailyEntries[habit.id];
                    // Save if numeric > 0 OR boolean === true
                    const isValid = habit.type === 'numeric' ? (val !== undefined && val !== '' && val > 0) : (val === true);
                    
                    if (isValid) {
                        newEntries.push({
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            date: selectedDate,
                            habit: habit.name,
                            habitId: habit.id,
                            type: habit.type,
                            value: val,
                            timestamp: new Date().toISOString()
                        });
                    }
                });

                const updatedLogs = [...cleanLogs, ...newEntries];
                updateData(updatedLogs, habits);
                setNotification({ msg: 'Protocol Committed', type: 'success' });
                setLoading(false);
            };

            const deleteLog = (logId) => {
                const newLogs = logs.filter(l => l.id !== logId && l.timestamp !== logId);
                updateData(newLogs, habits);
                setNotification({ msg: 'Entry Deleted', type: 'success' });
                if (viewingDay) {
                    const remaining = newLogs.filter(l => l.date === viewingDay.date);
                    if (remaining.length === 0) setViewingDay(null);
                    else setViewingDay({...viewingDay, logs: remaining});
                }
            };

            const saveHabit = (habit) => {
                let newHabits;
                if (habit.isNew) {
                    const { isNew, ...cleanHabit } = habit;
                    newHabits = [...habits, { ...cleanHabit, id: cleanHabit.name.toLowerCase().replace(/\s/g, '_') }];
                } else {
                    newHabits = habits.map(h => h.id === habit.id ? habit : h);
                }
                updateData(logs, newHabits);
                setEditingHabit(null);
                setNotification({ msg: 'Habit Saved', type: 'success' });
            };

            const deleteHabit = (habitId) => {
                if(!confirm("Delete this habit? Old logs will remain.")) return;
                const newHabits = habits.filter(h => h.id !== habitId);
                updateData(logs, newHabits);
                setEditingHabit(null);
                setNotification({ msg: 'Habit Deleted', type: 'success' });
            };

            const updateData = (newLogs, newHabits) => {
                setLogs(newLogs);
                setHabits(newHabits);
                localStorage.setItem('habitLogs', JSON.stringify(newLogs));
                localStorage.setItem('habitConfig', JSON.stringify(newHabits));
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(() => pushToCloud(newLogs, newHabits), 1000);
            };

            return (
                <div className="min-h-screen pb-24 bg-black selection:bg-zinc-800">
                    {notification && <Toast message={notification.message || notification.msg} type={notification.type} onClose={() => setNotification(null)} />}

                    {/* Header */}
                    <header className="sticky top-0 z-40 backdrop-blur-xl border-b border-zinc-800 bg-black/70">
                        <div className="max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center space-x-3">
                                <div className={`w-2.5 h-2.5 rounded-full transition-all duration-500 ${
                                    connectionStatus === 'connected' ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : 
                                    connectionStatus === 'error' ? 'bg-red-500' : 'bg-zinc-600'
                                }`}></div>
                                <h1 className="text-lg font-bold tracking-tighter text-zinc-100">HABIT OS <span className="text-[10px] bg-zinc-800 px-1 rounded text-zinc-400 ml-1 align-middle">PRO</span></h1>
                            </div>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 rounded-full hover:bg-zinc-800 transition-colors">
                                <Icon name="settings" size={20} className="text-zinc-400" />
                            </button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-3xl mx-auto px-4 py-6">
                        {activeTab === 'log' && (
                            <LogView 
                                habits={habits} 
                                dailyEntries={dailyEntries} 
                                setDailyEntries={setDailyEntries} 
                                selectedDate={selectedDate} 
                                setSelectedDate={setSelectedDate}
                                onCommit={handleCommit}
                                loading={loading}
                            />
                        )}
                        {activeTab === 'calendar' && <CalendarView logs={logs} habits={habits} setViewingDay={setViewingDay} />}
                        {activeTab === 'analytics' && <AnalyticsView logs={logs} habits={habits} />}
                        {activeTab === 'history' && <HistoryView logs={logs} deleteLog={deleteLog} />}
                    </main>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 w-full border-t border-zinc-800 bg-black/90 backdrop-blur-lg pb-safe z-50">
                         <div className="max-w-md mx-auto flex justify-around p-3">
                            {['log', 'calendar', 'analytics', 'history'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} 
                                    className={`flex flex-col items-center space-y-1 px-4 py-1 rounded-lg transition-all ${activeTab === tab ? 'text-white' : 'text-zinc-600 hover:text-zinc-400'}`}>
                                    <Icon name={tab === 'log' ? 'plus-circle' : tab === 'calendar' ? 'layout-grid' : tab === 'analytics' ? 'bar-chart-2' : 'list'} size={24} strokeWidth={activeTab === tab ? 2.5 : 2} />
                                    <span className="text-[9px] font-mono uppercase tracking-widest">{tab}</span>
                                </button>
                            ))}
                        </div>
                    </nav>

                    {/* Settings Modal */}
                    <Modal isOpen={isSettingsOpen} onClose={() => { setIsSettingsOpen(false); setEditingHabit(null); }} title="System Config">
                        <div className="space-y-6">
                            <div>
                                <h4 className="text-xs font-mono text-zinc-500 uppercase mb-3">Habit Management</h4>
                                <div className="space-y-2">
                                    {habits.map(h => (
                                        <div key={h.id} className="flex items-center justify-between bg-zinc-900/50 p-2 rounded border border-zinc-800">
                                            <div className="flex items-center gap-3">
                                                <div className="text-zinc-400"><Icon name={h.icon} size={16} /></div>
                                                <span className="text-sm text-zinc-300">{h.name}</span>
                                            </div>
                                            <button onClick={() => setEditingHabit(h)} className="text-zinc-500 hover:text-white p-1"><Icon name="edit-2" size={14} /></button>
                                        </div>
                                    ))}
                                    <button onClick={() => setEditingHabit({ isNew: true })} 
                                        className="w-full py-3 border border-dashed border-zinc-700 text-zinc-500 rounded text-xs font-mono hover:bg-zinc-900 hover:text-zinc-300 transition-colors">
                                        + ADD NEW HABIT
                                    </button>
                                </div>
                            </div>
                            <div className="border-t border-zinc-800 pt-4">
                                <h4 className="text-xs font-mono text-zinc-500 uppercase mb-3">Cloud Sync</h4>
                                <select className="input-tech w-full p-2 rounded bg-black text-sm mb-3" value={settings.mode} onChange={(e) => setSettings({...settings, mode: e.target.value})}>
                                    <option value="local">Offline Mode (Local)</option>
                                    <option value="cloud">Cloud Sync (Live)</option>
                                </select>
                                {settings.mode === 'cloud' && (
                                    <input placeholder="Script URL (/exec)" className="input-tech w-full p-2 rounded text-xs font-mono text-zinc-400"
                                        value={settings.googleScriptUrl} onChange={(e) => setSettings({...settings, googleScriptUrl: e.target.value})} />
                                )}
                            </div>
                            <button onClick={() => { localStorage.setItem('habitSettings', JSON.stringify(settings)); setIsSettingsOpen(false); }} 
                                className="w-full bg-white text-black py-3 rounded font-bold text-sm hover:bg-zinc-200">
                                SAVE & CLOSE
                            </button>
                        </div>
                    </Modal>

                    {/* Edit Habit Modal (Overlay) */}
                    <Modal isOpen={!!editingHabit} onClose={() => setEditingHabit(null)} title={editingHabit?.isNew ? "New Habit" : "Edit Habit"}>
                        {editingHabit && (
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs text-zinc-500 uppercase font-mono">Name</label>
                                    <input className="input-tech w-full p-2 rounded bg-black" value={editingHabit.name || ''} onChange={e => setEditingHabit({...editingHabit, name: e.target.value})} />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs text-zinc-500 uppercase font-mono">Type</label>
                                        <select className="input-tech w-full p-2 rounded bg-black text-sm" value={editingHabit.type || 'boolean'} onChange={e => setEditingHabit({...editingHabit, type: e.target.value})}>
                                            <option value="boolean">Check-in</option>
                                            <option value="numeric">Numeric</option>
                                        </select>
                                    </div>
                                    {editingHabit.type === 'numeric' && (
                                        <div>
                                            <label className="text-xs text-zinc-500 uppercase font-mono">Unit</label>
                                            <input className="input-tech w-full p-2 rounded bg-black" placeholder="min, count" value={editingHabit.unit || ''} onChange={e => setEditingHabit({...editingHabit, unit: e.target.value})} />
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <label className="text-xs text-zinc-500 uppercase font-mono mb-2 block">Icon</label>
                                    <div className="grid grid-cols-6 gap-2 bg-black/40 p-2 rounded border border-zinc-800 max-h-32 overflow-y-auto">
                                        {ICON_OPTIONS.map(icon => (
                                            <button key={icon} onClick={() => setEditingHabit({...editingHabit, icon})}
                                                className={`p-2 rounded flex items-center justify-center hover:bg-zinc-800 ${editingHabit.icon === icon ? 'bg-white text-black' : 'text-zinc-500'}`}>
                                                <Icon name={icon} size={18} />
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-zinc-500 uppercase font-mono mb-2 block">Color</label>
                                    <div className="flex gap-2 overflow-x-auto pb-2">
                                        {['#3b82f6','#06b6d4','#10b981','#84cc16','#f59e0b','#ef4444','#d946ef','#8b5cf6','#ec4899','#64748b'].map(c => (
                                            <button key={c} onClick={() => setEditingHabit({...editingHabit, color: c})}
                                                className={`w-8 h-8 rounded-full border-2 ${editingHabit.color === c ? 'border-white scale-110' : 'border-transparent opacity-50'}`}
                                                style={{backgroundColor: c}}></button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex gap-2 pt-4 border-t border-zinc-800">
                                    {!editingHabit.isNew && (
                                        <button onClick={() => deleteHabit(editingHabit.id)} className="flex-1 py-2 border border-red-900 text-red-500 rounded text-xs font-bold hover:bg-red-900/20">DELETE</button>
                                    )}
                                    <button onClick={() => saveHabit(editingHabit)} className="flex-[2] py-2 bg-white text-black rounded text-xs font-bold hover:bg-zinc-200">SAVE</button>
                                </div>
                            </div>
                        )}
                    </Modal>

                    {/* Day Detail Modal */}
                    <Modal isOpen={!!viewingDay} onClose={() => setViewingDay(null)} title={`Entries: ${viewingDay?.date}`}>
                        <div className="space-y-2">
                            {viewingDay?.logs.map(log => {
                                const habit = habits.find(h => h.name === log.habit) || {};
                                return (
                                    <div key={log.id || log.timestamp} className="flex items-center justify-between bg-zinc-900 p-3 rounded border border-zinc-800">
                                        <div className="flex items-center gap-3">
                                            <Icon name={habit.icon || 'circle'} size={18} className="text-zinc-400" />
                                            <div>
                                                <div className="text-sm text-white">{log.habit}</div>
                                                <div className="text-xs text-zinc-500">{log.value} {habit.unit}</div>
                                            </div>
                                        </div>
                                        <button onClick={() => deleteLog(log.id || log.timestamp)} className="p-2 text-red-500 hover:bg-red-950 rounded">
                                            <Icon name="trash-2" size={16} />
                                        </button>
                                    </div>
                                )
                            })}
                        </div>
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
